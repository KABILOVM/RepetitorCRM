import React, { useState, useEffect } from 'react';
import { NavLink } from 'react-router-dom';
import { 
  LayoutDashboard, 
  GraduationCap, 
  Users, 
  Library, 
  Calendar, 
  ClipboardCheck, 
  Phone, 
  AlertTriangle, 
  CreditCard, 
  UserPlus, 
  BarChart3, 
  Upload,
  LogOut,
  Menu,
  Moon,
  Sun,
  Award
} from 'lucide-react';

interface LayoutProps {
  children: React.ReactNode;
}

const Logo = () => (
  <svg viewBox="0 0 938 221" fill="none" xmlns="http://www.w3.org/2000/svg" className="h-10 w-auto">
    <path d="M214.106 109.607C214.106 165.664 168.663 211.107 112.607 211.107C56.5499 211.107 11.107 165.664 11.107 109.607C11.107 53.5505 56.5499 8.10742 112.607 8.10742C168.663 8.10742 214.106 53.5505 214.106 109.607Z" fill="#28A9E7"/>
    <path d="M267.071 76.1954H286.688C289.491 76.1954 291.44 78.7541 291.44 85.3338C291.44 92.1572 289.003 94.2286 286.566 94.2286H267.071V76.1954ZM297.289 105.317C312.519 104.098 317.393 93.4975 317.393 81.1911C317.393 66.9351 311.301 56.3344 294.364 56.3344H243.798V141.261H267.071V113.115H273.285C278.037 113.115 282.545 118.354 295.583 141.261H324.46C307.646 112.871 302.894 107.388 297.289 105.317Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M385.783 139.555C379.569 141.627 370.187 142.967 362.51 142.967C345.33 142.967 331.196 135.291 331.196 109.581C331.196 84.1154 343.381 76.8046 361.17 76.8046C382.981 76.8046 392.485 83.0188 390.169 117.014H353.981C354.225 123.594 358.124 124.69 365.435 124.69C369.943 124.69 378.229 123.959 382.615 122.984L385.783 139.555ZM362.998 93.2538C356.906 93.2538 355.2 95.2034 354.103 101.052H371.405C371.283 94.5941 368.968 93.2538 362.998 93.2538Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M426.186 121.644C426.186 123.35 429.232 124.934 433.497 124.934C440.442 124.934 442.635 121.4 442.635 110.556C442.635 97.3966 440.32 95.2034 433.253 95.2034C430.938 95.2034 427.648 95.6908 426.186 96.3V121.644ZM403.889 81.0692C410.59 78.6323 422.775 76.8046 433.253 76.8046C455.186 76.8046 464.811 84.4809 464.811 110.069C464.811 135.291 452.992 142.967 438.858 142.967C433.619 142.967 429.842 141.992 426.186 140.896V164.656H403.889V81.0692Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M531.036 139.555C524.822 141.627 515.44 142.967 507.764 142.967C490.584 142.967 476.45 135.291 476.45 109.581C476.45 84.1154 488.634 76.8046 506.424 76.8046C528.234 76.8046 537.738 83.0188 535.423 117.014H499.235C499.478 123.594 503.377 124.69 510.688 124.69C515.196 124.69 523.482 123.959 527.868 122.984L531.036 139.555ZM508.251 93.2538C502.159 93.2538 500.453 95.2034 499.357 101.052H516.659C516.537 94.5941 514.222 93.2538 508.251 93.2538Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M574.486 97.6403V117.501C574.486 122.375 575.948 124.325 581.918 124.325C585.574 124.325 588.498 123.594 591.301 122.741L594.834 139.555C589.717 141.627 581.797 142.967 574.242 142.967C560.595 142.967 552.188 138.824 552.188 120.06V97.6403H542.319V78.6323H552.188V70.5904L574.486 61.5738V78.6323H592.885V97.6403H574.486Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M626.694 141.261H604.396V78.6323H626.694V141.261ZM615.484 50.364C606.102 50.364 603.056 51.7043 603.056 60.5991C603.056 70.3468 606.102 72.0526 615.484 72.0526C624.866 72.0526 627.912 70.3468 627.912 60.5991C627.912 51.7043 624.866 50.364 615.484 50.364Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M668.931 97.6403V117.501C668.931 122.375 670.393 124.325 676.363 124.325C680.019 124.325 682.943 123.594 685.745 122.741L689.279 139.555C684.161 141.627 676.241 142.967 668.687 142.967C655.04 142.967 646.633 138.824 646.633 120.06V97.6403H636.763V78.6323H646.633V70.5904L668.931 61.5738V78.6323H687.329V97.6403H668.931Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M727.109 142.967C706.639 142.967 696.038 135.291 696.038 109.581C696.038 83.9935 706.883 76.8046 727.109 76.8046C747.701 76.8046 758.423 83.9935 758.423 109.581C758.423 135.291 747.823 142.967 727.109 142.967ZM727.109 93.8631C720.164 93.8631 718.336 95.2034 718.336 109.947C718.336 124.203 720.164 125.909 727.109 125.909C734.176 125.909 736.004 124.203 736.004 109.947C736.004 95.2034 734.176 93.8631 727.109 93.8631Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M772.776 141.261H795.074V102.27C795.074 98.7369 800.192 96.5437 806.162 96.5437C809.33 96.5437 813.107 96.9092 815.666 97.7621V77.1701C813.351 76.9264 811.28 76.8046 809.452 76.8046C800.435 76.8046 797.146 79.7289 795.074 83.628V78.6323H772.776V141.261Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M829.486 118.842C819.982 118.842 816.814 120.426 816.814 130.051C816.814 140.53 819.982 142.358 829.486 142.358C839.234 142.358 842.402 140.53 842.402 130.051C842.402 120.426 839.234 118.842 829.486 118.842Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M883.641 97.6403V117.501C883.641 122.375 885.103 124.325 891.073 124.325C894.729 124.325 897.653 123.594 900.456 122.741L903.989 139.555C898.871 141.627 890.952 142.967 883.397 142.967C869.75 142.967 861.343 138.824 861.343 120.06V97.6403H851.474V78.6323H861.343V70.5904L883.641 61.5738V78.6323H902.039V97.6403H883.641Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M924.639 50.364C915.257 50.364 912.211 51.7043 912.211 60.5991C912.211 70.3468 915.257 72.0526 924.639 72.0526C934.021 72.0526 937.067 70.3468 937.067 60.5991C937.067 51.7043 934.021 50.364 924.639 50.364ZM935.849 140.408C935.849 159.173 927.442 165.996 904.9 165.996V148.206C910.627 148.206 913.551 145.526 913.551 141.139V78.6323H935.849V140.408Z" className="fill-[#28A9E7] dark:fill-white"/>
    <path d="M110.107 5.37622C52.266 5.37622 5.37634 52.2664 5.37634 110.108C5.37634 167.949 52.2665 214.839 110.108 214.839C167.949 214.839 214.839 167.948 214.839 110.107C214.839 52.2659 167.949 5.37622 110.107 5.37622Z" strokeWidth="10.7527" className="stroke-[#28A9E7] dark:stroke-white"/>
    <mask id="mask0_4868_11" style={{ maskType: 'alpha' }} maskUnits="userSpaceOnUse" x="-1" y="0" width="222" height="221">
    <path d="M110.107 220.107C170.859 220.107 220.107 170.859 220.107 110.107C220.107 49.3561 170.859 0.107422 110.107 0.107422C49.356 0.107422 0.1073 49.3561 0.1073 110.107C0.1073 170.859 49.356 220.107 110.107 220.107Z" fill="#C4C4C4" stroke="#28A9E7" strokeWidth="0.215054"/>
    </mask>
    <g mask="url(#mask0_4868_11)">
    <path d="M156.152 180.933C177.045 180.933 187.184 164.038 191.493 154.342C193.845 149.045 192.775 142.146 187.484 139.794C182.187 137.442 180.285 145.983 175.656 151.141C173.4 153.658 166.66 159.955 156.147 159.955C144.885 159.955 134.741 154.498 134.644 154.444C129.578 151.633 123.212 153.466 120.4 158.527C117.589 163.594 119.427 169.987 124.494 172.804C125.093 173.135 139.321 180.933 156.152 180.933Z" fill="white"/>
    <path d="M100.095 213.245L135.184 206.5C135.184 206.5 145.917 188.878 141.87 167.835C136.659 140.731 166.126 123.51 158.841 85.6305C151.288 46.3402 114.943 23.1379 80.7836 29.6427C80.7626 29.648 80.7464 29.648 80.725 29.6534C80.7035 29.6587 80.682 29.6641 80.6664 29.6641C46.5335 36.2918 21.3861 71.317 28.9383 110.612C36.2235 148.486 71.767 152.068 76.9784 179.172C81.0296 200.22 100.095 213.245 100.095 213.245Z" fill="white"/>
    <path d="M98.5306 246.452C85.6654 246.452 81.1166 186.38 81.1166 186.38C80.3846 179.785 85.1361 173.841 91.7318 173.109C98.3275 172.371 104.271 177.128 104.998 183.724C104.998 183.724 111.39 246.452 98.5306 246.452Z" fill="white"/>
    <path d="M123.502 245.956C108.489 245.956 117.879 182.309 117.879 182.309C118.548 175.708 124.449 170.893 131.049 171.566C137.65 172.234 142.461 178.13 141.792 184.736C141.792 184.736 137.324 245.956 123.502 245.956Z" fill="white"/>
    <path d="M77.9271 33.8009C77.9271 33.8009 70.2142 33.7742 66.4032 29.5142C62.4857 25.1314 72.1971 23.8059 76.1419 27.0877C77.8734 28.5308 78.702 29.867 78.702 29.867C78.702 29.867 78.8944 23.2607 81.973 21.7161C85.0516 20.1767 87.4198 23.1164 86.0941 25.6659C84.7684 28.2154 84.7684 28.2155 84.7684 28.2155C84.7684 28.2155 87.0614 24.9711 91.1078 23.6936C94.3895 22.6514 97.3129 22.6407 96.1102 25.4468C95.2977 27.3335 88.0663 32.299 88.0663 32.299L77.9271 33.8009Z" fill="white"/>
    <path d="M147.263 58.5266C145.777 59.5793 144.232 60.5413 142.682 61.4768C141.127 62.4016 139.534 63.2566 137.914 64.053C136.712 64.657 135.472 65.218 134.243 65.7312C133.339 64.1599 132.431 62.594 131.5 61.0437L131.431 60.9368C130.891 60.1619 129.817 59.9802 129.047 60.5256L128.951 60.595C127.348 61.7224 125.723 62.8079 124.066 63.8445C122.403 64.8762 120.752 65.9182 119.052 66.886C117.358 67.8586 115.642 68.7888 113.905 69.6707C113.488 69.8792 113.06 70.0872 112.638 70.2957L113.242 66.7092C113.354 66.0144 113.157 65.261 112.638 64.7053C111.751 63.7429 110.244 63.6843 109.276 64.5769L109.25 64.6038C105.599 67.9763 101.473 70.9587 97.0951 73.5671C92.7553 76.2556 88.1693 78.5911 83.5194 80.8308C81.1942 81.9529 78.8373 83.0115 76.4589 84.0373C74.0907 85.0906 71.6962 86.1008 69.286 87.0627C64.4755 89.0456 59.5956 90.8791 54.6781 92.6965C59.8788 91.9587 64.9886 90.7346 70.0716 89.3665C72.5995 88.6448 75.1224 87.886 77.6239 87.0681C80.12 86.2239 82.5946 85.3152 85.0531 84.3528C89.9759 82.4236 94.7758 80.1467 99.4364 77.5383C102.216 75.9133 104.963 74.1711 107.577 72.22L107.32 73.9197L107.309 73.9783C107.245 74.4006 107.293 74.8445 107.48 75.2615C107.994 76.4265 109.356 76.9451 110.516 76.4265C112.473 75.5554 114.242 74.6521 116.022 73.6418C117.796 72.6477 119.538 71.6052 121.249 70.5203C122.954 69.4299 124.654 68.3235 126.279 67.1155C127.422 66.282 128.539 65.4158 129.651 64.5447C130.549 65.8328 131.447 67.1316 132.367 68.4036L132.468 68.5427C132.853 69.0774 133.579 69.2698 134.189 68.9705C135.942 68.1042 137.519 67.1692 139.112 66.1697C140.678 65.1541 142.196 64.0637 143.665 62.925C145.14 61.7869 146.536 60.5574 147.872 59.2747C149.219 58.0027 150.448 56.613 151.619 55.1965C150.224 56.3831 148.743 57.468 147.263 58.5266Z" fill="#231F20"/>
    <path d="M138.046 99.0448C139.335 102.615 143.268 104.459 146.839 103.177C150.409 101.889 152.259 97.9545 150.971 94.3841C149.688 90.8138 145.748 88.9642 142.178 90.2523C138.608 91.5404 136.758 95.4745 138.046 99.0448Z" fill="#231F20"/>
    <path d="M147.76 85.7585C145.419 86.3357 143.452 86.8005 141.715 87.6716C140.849 88.0994 140.042 88.6179 139.267 89.2644C138.476 89.906 137.738 90.6863 136.878 91.5574C136.717 89.1204 138.321 86.6296 140.657 85.5232C141.806 84.9568 143.073 84.7053 144.302 84.7429C145.515 84.7854 146.728 85.0637 147.76 85.7585Z" fill="#231F20"/>
    <path d="M91.5008 115.826C92.7889 119.391 90.9398 123.33 87.3641 124.618C83.7933 125.901 79.8597 124.057 78.5716 120.486C77.2836 116.916 79.1327 112.977 82.703 111.694C86.2738 110.406 90.2128 112.255 91.5008 115.826Z" fill="#231F20"/>
    <path d="M75.554 111.791C75.9017 110.599 76.6605 109.616 77.5692 108.792C78.4886 107.985 79.6273 107.365 80.8724 107.071C83.3739 106.435 86.2015 107.328 87.6336 109.311C86.4095 109.193 85.346 109.059 84.3304 109.07C83.3206 109.065 82.369 109.188 81.4334 109.407C79.5311 109.85 77.7191 110.743 75.554 111.791Z" fill="#231F20"/>
    <path d="M106.732 109.766C102.547 98.1673 89.7083 92.1332 78.1101 96.3182C66.5115 100.498 60.4768 113.336 64.657 124.935C68.8367 136.533 81.6804 142.573 93.2786 138.388C104.877 134.208 110.911 121.37 106.732 109.766ZM102.21 111.396C105.492 120.504 100.756 130.584 91.6487 133.866C82.5408 137.148 72.4656 132.412 69.1785 123.305C65.8968 114.202 70.6326 104.122 79.74 100.835C88.8479 97.5531 98.9285 102.288 102.21 111.396Z" fill="#231F20"/>
    <path d="M164.64 88.8941C160.461 77.2955 147.617 71.2613 136.018 75.4464C124.42 79.6261 118.386 92.4645 122.565 104.063C126.745 115.661 139.589 121.695 151.187 117.516C162.791 113.331 168.826 100.492 164.64 88.8941ZM160.118 90.524C163.4 99.6319 158.665 109.713 149.557 112.994C140.45 116.276 130.374 111.535 127.087 102.433C123.805 93.3248 128.541 83.2496 137.649 79.9625C146.756 76.6754 156.837 81.4166 160.118 90.524Z" fill="#231F20"/>
    <path d="M105.524 108.518L101.499 105.894C103.974 102.104 107.539 99.2823 111.809 97.7427C116.048 96.2139 120.564 96.1021 124.867 97.4165L123.461 102.013C120.163 101.003 116.695 101.088 113.44 102.265C110.163 103.446 107.427 105.61 105.524 108.518Z" fill="#231F20"/>
    <path d="M107.807 121.493L117.653 118.003L117.829 117.939L127.675 114.449C127.675 114.449 129.684 120.023 131.042 126.806C132.255 132.873 129.957 138.126 125.569 139.768V139.773C125.553 139.778 125.536 139.789 125.521 139.794C125.51 139.8 125.494 139.8 125.478 139.805C125.467 139.811 125.456 139.821 125.44 139.826C125.425 139.832 125.403 139.832 125.387 139.837C120.946 141.328 115.852 138.693 112.971 133.215C109.759 127.089 107.807 121.493 107.807 121.493Z" fill="#231F20"/>
    <path d="M112.974 133.21C112.37 132.066 111.82 130.943 111.312 129.869C113.108 128.373 119.206 124.685 131.361 129.933C131.371 134.615 129.185 138.416 125.572 139.768V139.773C125.556 139.778 125.54 139.789 125.524 139.795C125.513 139.8 125.497 139.8 125.481 139.805C125.471 139.811 125.46 139.821 125.444 139.827C125.428 139.832 125.406 139.832 125.39 139.838C120.943 141.323 115.849 138.688 112.974 133.21Z" fill="#E23D3A"/>
    <path d="M75.8582 168.981C82.0208 163.535 91.2405 166.677 93.7156 174.497C95.4471 179.965 88.9959 183.771 85.9866 187.384C81.9192 192.258 78.3914 198.057 78.1297 204.573C77.8782 210.875 79.8348 219.747 74.3509 221.613C69.3426 223.318 66.2962 217.935 64.5218 214.29C61.9935 209.089 60.9192 203.739 61.4695 197.94C61.8812 193.594 63.2654 189.447 65.115 185.508C67.1297 181.199 70.9461 173.321 75.8582 168.981Z" fill="white"/>
    <path d="M118.706 167.675L118.775 167.659L121.48 166.927L122.453 159.861L118.214 157.172L116.103 157.744L116.039 157.76L113.922 158.332L111.613 162.784L116.001 168.402L118.706 167.675Z" fill="#231F20"/>
    <path d="M127.563 200.251L132.844 190.925L121.828 168.588L119.22 169.294L119.188 169.299L119.156 169.31L116.542 170.015L118.236 194.858L127.493 200.268L127.51 200.337L127.536 200.294L127.579 200.321L127.563 200.251Z" fill="#231F20"/>
    </g>
  </svg>
);

const SidebarItem = ({ to, icon: Icon, label }: { to: string; icon: any; label: string }) => (
  <NavLink
    to={to}
    className={({ isActive }) =>
      `flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors text-sm ${
        isActive 
          ? 'bg-blue-600 text-white shadow-md' 
          : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-blue-600 dark:hover:text-blue-400'
      }`
    }
  >
    <Icon size={18} />
    <span className="font-medium">{label}</span>
  </NavLink>
);

export const Layout: React.FC<LayoutProps> = ({ children }) => {
  const [isDark, setIsDark] = useState(() => {
    if (typeof window !== 'undefined') {
      return document.documentElement.classList.contains('dark');
    }
    return false;
  });

  const toggleTheme = () => {
    const newMode = !isDark;
    setIsDark(newMode);
    if (newMode) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    }
  };

  return (
    <div className="flex h-screen bg-slate-50 dark:bg-slate-900 overflow-hidden transition-colors duration-200">
      {/* Sidebar */}
      <aside className="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex-shrink-0 hidden md:flex flex-col z-10 transition-colors duration-200">
        <div className="h-20 flex items-center justify-center border-b border-transparent dark:border-slate-700/50">
            <NavLink to="/" className="flex items-center justify-center w-full px-6 group">
                <Logo />
            </NavLink>
        </div>

        <nav className="flex-1 px-3 py-4 space-y-1 overflow-y-auto custom-scrollbar">
          <SidebarItem to="/" icon={LayoutDashboard} label="Главная" />
          <SidebarItem to="/students" icon={GraduationCap} label="Ученики" />
          <SidebarItem to="/teachers" icon={Users} label="Преподаватели" />
          <SidebarItem to="/groups" icon={Library} label="Группы" />
          <SidebarItem to="/schedule" icon={Calendar} label="Расписание" />
          <SidebarItem to="/attendance" icon={ClipboardCheck} label="Посещаемость" />
          <SidebarItem to="/exams" icon={Award} label="Успеваемость" />
          <SidebarItem to="/calls" icon={Phone} label="Звонки родителям" />
          <SidebarItem to="/violations" icon={AlertTriangle} label="Нарушения" />
          <SidebarItem to="/finance" icon={CreditCard} label="Оплаты" />
          <SidebarItem to="/crm" icon={UserPlus} label="Лиды" />
          <SidebarItem to="/analytics" icon={BarChart3} label="Аналитика" />
          <SidebarItem to="/import" icon={Upload} label="Импорт данных" />
        </nav>

        <div className="p-4 border-t border-slate-100 dark:border-slate-700">
          <button className="flex items-center gap-3 px-4 py-2 text-slate-500 dark:text-slate-400 hover:text-red-500 dark:hover:text-red-400 w-full transition-colors text-sm font-medium hover:bg-red-50 dark:hover:bg-red-900/10 rounded-lg">
            <LogOut size={18} />
            <span>Выйти</span>
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <div className="flex-1 flex flex-col overflow-hidden relative">
        <header className="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 shadow-sm z-10 transition-colors duration-200">
          <div className="flex items-center gap-4">
            <button className="md:hidden p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md">
              <Menu size={24} />
            </button>
            <h2 className="text-lg font-semibold text-slate-800 dark:text-slate-100 hidden sm:block">Панель управления</h2>
          </div>
          <div className="flex items-center gap-4">
            <button 
              onClick={toggleTheme}
              className="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors"
              title={isDark ? "Включить светлую тему" : "Включить темную тему"}
            >
              {isDark ? <Sun size={20} /> : <Moon size={20} />}
            </button>
            
            <div className="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>

            <div className="flex flex-col items-end">
              <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Администратор</span>
              <span className="text-xs text-slate-500 dark:text-slate-400">Душанбе, Филиал 1</span>
            </div>
            <div className="h-9 w-9 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold border-2 border-slate-100 dark:border-slate-700 shadow-sm">
              А
            </div>
          </div>
        </header>

        <main className="flex-1 overflow-auto p-6 bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
          {children}
        </main>
      </div>
    </div>
  );
};